
// import 'dart:html';

import 'package:chamber_of_commerce/main.dart';
import 'package:chamber_of_commerce/pages/user/Business.dart';
import 'package:chamber_of_commerce/pages/user/Business_Options/Agriculture/Agriculture_Home.dart';
import 'package:chamber_of_commerce/pages/user/Business_Options/Export/Export_Home.dart';
import 'package:chamber_of_commerce/pages/user/Business_Options/Import/Import_Home.dart';
import 'package:chamber_of_commerce/pages/user/Company%20_business.dart';
import 'package:chamber_of_commerce/pages/user/Company.dart';
import 'package:chamber_of_commerce/pages/user/Company_detail.dart';
import 'package:chamber_of_commerce/pages/user/Home.dart';
import 'package:chamber_of_commerce/widgets/BottomNavBar.dart';
import 'package:chamber_of_commerce/widgets/ContactTemplete.dart';
import 'package:chamber_of_commerce/widgets/CustomBottomNavBar.dart';
import 'package:chamber_of_commerce/widgets/GridScreen.dart';
import 'package:chamber_of_commerce/widgets/GridSingle.dart';
import 'package:chamber_of_commerce/widgets/SearchField.dart';
import 'package:chamber_of_commerce/widgets/SearchFieldBusiness.dart';
import 'package:chamber_of_commerce/widgets/business_top_list.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_database/firebase_database.dart';
import 'package:flutter/cupertino.dart';
import 'package:flutter/material.dart';
import 'package:flutter/widgets.dart';
import 'package:flutter_svg/svg.dart';
import 'package:share_plus/share_plus.dart';
import 'package:url_launcher/url_launcher.dart';


class Agriculture_listing extends StatefulWidget {
  final int index;
  final String title;
  final List<Map<String, String>> businessCompanyProfile ;
  const Agriculture_listing({super.key,required this.index,required this.title,required this.businessCompanyProfile});
  @override
  State<Agriculture_listing> createState() => _Agriculture_listingState();
}

class _Agriculture_listingState extends State<Agriculture_listing> {
    Stream<DatabaseEvent>? _userStream;
  final dbRef = FirebaseDatabase.instance.ref('Query10'); // Replace with your actual query path
  final _pageSize = 100; // Adjust the page size as needed
  String _lastKey = ''; // Stores the key of the last item in the current page
  bool _isLoadingMore = false;

  Stream<DatabaseEvent> _getUserStream() {
    // Initial query to fetch the first page
    if (_lastKey.isEmpty) {
      return dbRef.limitToFirst(_pageSize).onValue;
    } else {
      // Subsequent queries to fetch additional pages using startAfter
      return dbRef.orderByKey().startAfter(_lastKey).limitToFirst(_pageSize).onValue;
    }
  }

  @override
  void initState() {
    super.initState();
  }

  @override
  void dispose() {
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar:  AppBar(
        // Padding: const EdgeInsets.only(left: 20.0, top: 15.0, right: 10.0, bottom: 5.0),
        backgroundColor:Color.fromARGB(255, 255, 255, 255),
      
         leading: Row(
           children: [
             Column(
               children: [
                 IconButton(
                  icon: Icon(Icons.arrow_back),
                  onPressed:()=>{
                   Navigator.push(
                      context,
                       TransparentRoute(
               
                page:   Agriculture_Home(),
              ),
                    ),
                    }
                  ),
       
               ],
             ),
            
           ],
         ),
        // padding: const EdgeInsets.all(16.0), // Add padding on all sides
    shape: RoundedRectangleBorder(
      borderRadius: BorderRadius.circular(30.0), // Set border radius
    ),
       
        title: Text(
          widget.title,
          style: const TextStyle(
           color: Colors.black,
           fontWeight: FontWeight.bold,
           fontSize: 18,
          ),
        ),
       //should be replace by botton
       actions: [
          Padding(padding: EdgeInsets.only(right: 20),
         child:  SvgPicture.asset('assets/images/chamber_icon.svg')
          ,),
         
    ],
        elevation: 0.0,//remove shadow
        centerTitle: true,
        
      ),
      body: StreamBuilder<DatabaseEvent>(
        stream: _getUserStream(),
        builder: (context, snapshot) {
          if (snapshot.hasError) {
            return Center(
              child: Text('Error: ${snapshot.error}'),
            );
          }

          if (snapshot.connectionState == ConnectionState.waiting) {
            return const Center(child: CircularProgressIndicator());
          }

          final allData = snapshot.data!.snapshot.value as List<dynamic>;
          print(allData);
          // final data
          //  = allData.expand((element) {
          //   final companyName = element['Sector']?.toString() ?? '';
          //   return companyName.startsWith("AGRICULTURE, HUNTING, FORESTRY, AND FISHING")
          //       ? [element]
          //       : [];
          // }).toList();
              // print(data);
          // Apply any further filtering based on your data structure and widget.index
          List<dynamic> filteredBusinesses = allData;
          if (filteredBusinesses.isEmpty) {
            return const Center(child: Text('No businesses found'));
          }

          return _buildContent(filteredBusinesses);
        },
      ),
      bottomNavigationBar: const CustomeButtomNavBar(index: 2),
    );
  }

  ///
  ///
  ///
  
    Widget _buildContent(List<dynamic> snapshot) {
    //  print(snapshot.data!.snapshot.value as List<dynamic>);
  //     if (snapshot.hasError) {
  //   return Center(
  //     child: Text('Error: ${snapshot.error}'),
  //   );
  // }

  // if (snapshot.connectionState == ConnectionState.waiting) {
  //   return const Center(child: CircularProgressIndicator());
  // }
  //  print(snapshot.data);
  // final all_data = snapshot;
  //  snapshot.data!.snapshot.value as List<dynamic>;
  // final data = 
  // all_data.expand((element) {
    // ... filtering logic using entry.value as Map<String, dynamic>
  //   final companyName = element['Sector']?.toString() ?? '';
  //   return companyName.startsWith("AGRICULTURE, HUNTING, FORESTRY, AND FISHING") ? [element] : [];
  // }).toList();
  // print(data);
  List<dynamic> filteredBusinesses = snapshot;
  // if (filteredBusinesses.isEmpty) {
  //   return const Center(child: Text('No businesses found'));
  // }
  //based on the index categorize SIT+A1:I15802C Description
  var items = [
  "TEA AND BEVERAGE ,SPICE CROPS, MEDICINAL AND AROMATIC CROPS FARMING" ,
"FLOURICULTURE" ,
"POULTRY" ,
"COTTON FARMING" ,
"GROWING OF CROPS COMBINED WITH FARMING OF ANIMALS (MIXED FARMING)" ,
"PICTURE, SCULPTURE,GALLERY/ STUDIO SERVICE" ,
"CEREALS/PULSES FARMING" ,
"DIFFERENT SEEDLINGS FARMING" ,
"OIL SEEDS FARMING" ,
"PEST CONTROL" ,
"FRUITS FARMING" ,
"VEGETABLES FARMING" ,
"VEGETABLE,FRUIT,PLANT AND PLANT SEED PRODUCTION" ,
"GROWING OF CEREALS" ,
"BEE KEEPING" ,
"CATTLE AND PACK ANIMALS HUSBANDARY" ,
"FISH HATCHERIES AND FISH FARMS" ,
"DAIRY FARMING" ,
"COFFEE FARMING" ,
"FLORICULTURE" ,
"GROWING OF HERBS AND OTHERS" ,
"AGRICULTURAL SUPPORT SERVICE" ,



];


 items.sort((a,b)=>a.compareTo(b));
  var currentItem =  items[widget.index];
 
    filteredBusinesses = filteredBusinesses.toList();
    // = filteredBusinesses.expand((element) {
    //   // ... filtering logic using entry.value as Map<String, dynamic>
    //   final company = element['Sub-Sector']?.toString() ?? '';
    //   return company.startsWith("${currentItem}") ? [element] : [];
    // }).toList();



 
  
 

  return filteredBusinesses.isEmpty
    ? const Padding(
        padding: EdgeInsets.all(8.0),
        child: Center(
          child: Text("No Business Found"),
        ) ,
      )
    :  
    
    
       ListView.builder(
       itemCount: filteredBusinesses.length,
       itemBuilder: (context, index) {
         final businessData = filteredBusinesses[index];
         final name = businessData['Account Name'];
         final email = businessData['Email'];
         final tel = businessData['Tel'];
         final mobile = businessData["Mobile"];
         final website = businessData["Website"];
         final sector = businessData["Sector"];
         final subSector = businessData["Sub-Sector"];
       
         // Extract business information based on your data structure
         return Padding(
           padding: const EdgeInsets.only(left: 20.0,right: 20,bottom: 16),
           child:
               GestureDetector(
                onTap: () {
          Navigator.push(
            context,
            MaterialPageRoute(
              builder: (context) => CompanyDetail(data: businessData),
            ),
          );
        },
                 child: Container(
                  
                    decoration: BoxDecoration(
                     
                         color: const Color.fromARGB(255,229,234,232),
                 
                 borderRadius:BorderRadius.circular(20), // Set border width
                 
                   ),
                   // color: const Color.fromARGB(255,229,234,232),
                   //  width: MediaQuery.of(context).size.width * 0.8,
                   //  height: 230,
                   child:  Padding(padding: EdgeInsets.all(16),
                   child: Column(children: [
                     Row(
                       children: [
                         Expanded(child: Text(name,style: const TextStyle(fontWeight: FontWeight.bold,fontSize: 16), softWrap: true,overflow: TextOverflow.ellipsis,textAlign: TextAlign.left)),
                       ],
                     ),
                
                 ContactTemeplete(tel: tel,mobile: mobile,email: email, website: website,),
                      SizedBox(height: 5,),
                     Text('Sector: $sector',softWrap: true,overflow: TextOverflow.ellipsis,maxLines: 2,),
                     SizedBox(height: 5,),
                      Text('Sub Sector: $subSector',softWrap: true,overflow: TextOverflow.ellipsis,maxLines: 2,),
                     SizedBox(height: 20,),
                 
                 
                     
         
                   ],))
                    
                 ),
               ),
            
         
         );
     
       },
         );
  
}
//  void _loadMoreUsers() async {
//     setState(() {
//       _isLoadingMore = true;
//     });

//     // Update lastKey for the next page query
//     final snapshot = await dbRef.orderByKey().endAt(_lastKey).limitToLast(1).once();
//     _lastKey = snapshot.value!.key!;

//     setState(() {
//       _isLoadingMore = false;
//     });
//   }
}































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































 

















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































